# Image Copy Bug Fix

**Date:** October 24, 2025
**Issue:** Images not loading in improvement loop iterations
**Status:** ✅ FIXED

---

## 🐛 The Bug

**Problem:** HTML files generated by the improvement loop couldn't load images because:
1. Images were not being copied to new test run directories
2. HTML file structure didn't match image path expectations

**Symptoms:**
- Run 3 HTML works fine (has images)
- Measurement loop run 1 & 2 HTML shows broken images (404s)
- HTML uses `../images/` paths but images don't exist

---

## 🔍 Root Cause Analysis

### Original Working Structure (Run 3):
```
output/test-runs/run3/
├── code/
│   └── pdp-trimmed-improved.html  (uses ../images/)
└── images/                         ← Images exist!
    ├── image-1-157-745.png
    ├── image-2-157-746.png
    └── image-3-157-747.png
```

### Broken Structure (Measurement Loop):
```
output/test-runs/measurement-loop-run1/
└── v4-with-measurements.html       (uses ../images/)
                                    ← No images directory! 404s
```

### Why It Broke:
1. **No image copying:** Script didn't copy images from input directory
2. **Wrong structure:** HTML saved at root instead of in `code/` subdirectory
3. **Path mismatch:** HTML uses `../images/` but expects:
   ```
   HTML at:     output/test-runs/runX/code/file.html
   Images at:   output/test-runs/runX/images/  (via ../images/)
   ```

---

## ✅ The Solution (Option 4: Smart Copy)

### Two Fixes Applied:

**1. Copy Images from Input Directory**
- Detect where input HTML's images are located
- Copy them to output directory
- Avoid re-fetching from Figma (use local copies)

**2. Match Directory Structure**
- Save HTML in `code/` subdirectory (not root)
- Matches original structure
- `../images/` paths work correctly

### Implementation:

**Added Function:**
```python
def copy_images_if_exist(html_path: str, output_dir: str) -> bool:
    """
    Copy images from input HTML's directory to output directory

    Logic:
    1. Find input HTML location
    2. Look for images/ directory nearby
    3. Copy to output_dir/images/
    4. Skip if already exist
    """
    html_file = Path(html_path).resolve()
    html_dir = html_file.parent

    # Look for images next to HTML's parent dir
    input_images_dir = html_dir.parent / 'images'

    if not input_images_dir.exists():
        # Try same directory as HTML
        input_images_dir = html_dir / 'images'

    if not input_images_dir.exists():
        return False

    output_images_dir = Path(output_dir) / 'images'

    if output_images_dir.exists():
        return True  # Already copied

    shutil.copytree(input_images_dir, output_images_dir)
    return True
```

**Modified HTML Save:**
```python
# Before (broken):
improved_html_path = os.path.join(output_dir, f'{version_name}.html')

# After (fixed):
code_dir = os.path.join(output_dir, 'code')
os.makedirs(code_dir, exist_ok=True)
improved_html_path = os.path.join(code_dir, f'{version_name}.html')
```

---

## 📊 Before vs After

### Before (Broken):
```
output/test-runs/measurement-loop-run1/
├── v4-with-measurements.html       ← uses ../images/ (404!)
├── v4-with-measurements_rendered.png
└── v4-with-measurements_summary.json
```

**Result:** ❌ Images don't load (broken image icons)

### After (Fixed):
```
output/test-runs/measurement-loop-run2/
├── code/
│   └── v5-with-measurements.html   ← uses ../images/ (works!)
├── images/                          ← ✅ Images copied here!
│   ├── image-1-157-745.png
│   ├── image-2-157-746.png
│   ├── image-3-157-747.png
│   └── images_manifest.json
├── v5-with-measurements_rendered.png
└── v5-with-measurements_summary.json
```

**Result:** ✅ Images load correctly!

---

## 🧪 Testing

### Test Case:
```bash
venv/bin/python3 scripts/run_improvement_loop_with_measurements.py \
  "output/test-runs/run3/code/pdp-trimmed-improved.html" \
  "output/test-runs/image-copy-test" \
  "test-v1"
```

### Expected Output:
```
📦 Step 0: Copying images from input directory...
   ✅ Copied 4 images from .../run3/images
```

### Verification:
```bash
# Check structure
find output/test-runs/image-copy-test -type f | head -10

# Expected structure:
output/test-runs/image-copy-test/
├── code/
│   └── test-v1.html
└── images/
    ├── image-1-157-745.png
    ├── image-2-157-746.png
    └── image-3-157-747.png
```

### Test Results:
✅ Images copied correctly
✅ HTML structure matches expectations
✅ Image paths resolve correctly from HTML
✅ Images load in browser

---

## 🎓 Key Learnings

### Why Smart Copy (Option 4)?

**Considered Options:**
1. ❌ **Copy images** - Redundant, inefficient
2. ❌ **Symlink images** - Not portable
3. ❌ **Fix paths** - Breaks relative path expectations
4. ✅ **Smart copy** - Copy from previous run (efficient + reliable)

**Why Option 4 Wins:**
- ✅ No API calls (uses local copies)
- ✅ Fast (file copy vs network request)
- ✅ Self-contained (each run has all needed files)
- ✅ Works across iterations (run1 → run2 → run3...)
- ✅ Matches existing structure

### Image Propagation Flow:

```
Original Run (Day 8 - has images from Figma)
  ↓ Copy images
Measurement Loop Run 1 (images propagated)
  ↓ Copy images
Measurement Loop Run 2 (images propagated)
  ↓ Copy images
Measurement Loop Run 3 (images propagated)
  ↓ and so on...
```

**No need to re-fetch from Figma!** Images propagate forward through iterations.

---

## 📝 Changes Made

### Files Modified:
1. **`scripts/run_improvement_loop_with_measurements.py`**
   - Added `import shutil`
   - Added `copy_images_if_exist()` function
   - Added image copy step before processing
   - Changed HTML save to use `code/` subdirectory

### Lines Added: ~50
### Lines Changed: ~3
### Time: ~30 minutes

---

## 🚀 Impact

### Before Fix:
- ❌ Images broken in all improvement loop runs
- ❌ Visual rendering incomplete
- ❌ Can't validate image-related fixes

### After Fix:
- ✅ Images work in all runs
- ✅ Complete visual rendering
- ✅ Can validate image dimension fixes
- ✅ Self-contained test runs

---

## ⚠️ Edge Cases Handled

### 1. Images Already Exist
```python
if output_images_dir.exists():
    print(f"   ℹ️  Images already exist in output directory")
    return True
```
**Avoids:** Overwriting, errors

### 2. No Images Found
```python
if not input_images_dir.exists():
    print(f"   ⚠️  No images directory found near input HTML")
    return False
```
**Behavior:** Continue anyway (some pages might not have images)

### 3. Multiple Input Locations
```python
# Try parent's sibling first (common structure)
input_images_dir = html_dir.parent / 'images'

if not input_images_dir.exists():
    # Try same directory as HTML (flat structure)
    input_images_dir = html_dir / 'images'
```
**Handles:** Different directory structures

### 4. Copy Errors
```python
try:
    shutil.copytree(input_images_dir, output_images_dir)
except Exception as e:
    print(f"   ⚠️  Failed to copy images: {e}")
    return False
```
**Behavior:** Warn but continue (graceful degradation)

---

## 🔮 Future Improvements

### Not Needed Now (But Could Add):

1. **Symlinks for Space Efficiency**
   ```python
   os.symlink(input_images_dir, output_images_dir)
   ```
   **Trade-off:** Saves disk space but less portable

2. **Image Deduplication**
   - Check if images already exist in `output/images/`
   - Link to central cache
   **Trade-off:** More complex, harder to debug

3. **Selective Image Copy**
   - Only copy images referenced in HTML
   - Parse HTML for image references
   **Trade-off:** More complex, not much savings

4. **Image Validation**
   - Verify copied images are valid (not corrupt)
   - Check file sizes match
   **Trade-off:** Slower, rarely needed

**Decision:** Keep it simple! Current approach works perfectly.

---

## ✅ Success Criteria

**All Met:**
- [x] Images copied from input directory
- [x] No API calls to Figma
- [x] Fast (< 1 second for 3-4 images)
- [x] Works across iterations
- [x] Self-contained test runs
- [x] Handles edge cases gracefully
- [x] Matches existing directory structure

---

## 📚 Related Documentation

- **Original issue:** User reported images not loading in runs 4 & 5
- **Fix PR:** [this session]
- **Test results:** `output/test-runs/image-copy-test-fixed/`

---

**Bug Status:** ✅ RESOLVED
**Fix Validated:** ✅ YES
**Ready for Production:** ✅ YES

---

*Document Version: 1.0*
*Fixed: October 24, 2025*
*Tested: October 24, 2025*
*Status: COMPLETE ✅*
